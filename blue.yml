- name: Create EC2
  hosts: [localhost]
  connection: local
  gather_facts: false
  vars:
    ansible_python_interpreter: /usr/bin/python3
    application: djangoblue
    region: us-west-2
  
  tasks:
    - name: Collect EC2 info
      ec2_instance_facts:
        region: "{{ region }}"
        instance_ids: 
          - i-0c2a60beb918e140a
      register: ec2_instance
    
    - name: Add EC2 instance to host
      add_host:
        name: "{{ item.public_ip_address }}"
        groups: server
      with_items: "{{ ec2_instance.instances }}"

- name: Deploy EC2
  hosts: server
  remote_user: ubuntu
  become: yes 
  gather_facts: false
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Install Docker
      apt:
        pkg: 
          - docker.io
          - python3-pip

    - name: Pull & Run Docker
      docker_container:
        name: django_container
        image: zhan430/traveblog:lastest
        pull: yes
        state: started

- name: Setup Route53
  hosts: [localhost]
  gather_facts: false
  vars:
    application: djangoblue
    region: us-west-2
  
  tasks:
    - name: Add EC2 instance to ELB
      ec2_elb:
        state: present
        ec2_elbs: elb.name
        region: "{{ region }}"
        instance_id: "{{ item.instance_id }}"
      with_items: "{{ ec2_instance.instances }}"

    - name: change route53
      route53:
        state: present
        zone: lazxy.com
        record: www.lazxy.com
        failover: PRIMARY
        type: CNAME
        ttl: 30
        identifier: blue
        private_zone: yes
        overwrite: yes
        value: "{{ application }}-load-balancer"
        wait: yes
        health_check: "f727fa34-2bbd-4288-b59f-7ca9f74c5f34"


